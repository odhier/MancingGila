local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local ItemsFolder = ReplicatedStorage:WaitForChild("Items")
local apiUrl = "https://flooxa.odhier.site/api/roblox"
local function getRequestFunction()
    return (http_request or request or (syn and syn.request) or (fluxus and fluxus.request))
end

local requestFunc = getRequestFunction()

local TARGET_EVENT_NAME = "RE/DisplaySystemMessage"
local function dumpTable(t, path) path = path or "a1" for k, v in pairs(t) do local keyPath = path .. "[" .. tostring(k) .. "]" if type(v) == "table" then print(keyPath, "= <table>") dumpTable(v, keyPath) else print(keyPath, "=", v) end end end
local function getTierFromTextColor(textColor)
	local flat = flattenColorSequenceToString(textColor)
	if not flat then return nil, nil end
	local tier = TIER_BY_STRING[flat]
	if tier then return tier, flat end
	local normalized = flat:gsub("(%s)1%.000000(%s)", "%11%2")
		:gsub("^1%.000000(%s)", "1%1")
		:gsub("(%s)1%.000000$", "%11")
	tier = TIER_BY_STRING[normalized]
	return tier, flat
end

local function serialize(value)
    local t = typeof(value)

    if t == "table" then
        local result = {}
        for k, v in pairs(value) do
            result[k] = serialize(v)
        end
        return result

    elseif t == "NumberRange" then
        return {
            __type = "NumberRange",
            Min = value.Min,
            Max = value.Max
        }

    elseif t == "Instance" then
        return tostring(value)

    else
        return value
    end
end

local function getFishData(name)
local itemModule = ItemsFolder:FindFirstChild(name)

if itemModule and itemModule:IsA("ModuleScript") then
    local data = require(itemModule)

    local Tier = data.Data and data.Data.Tier
    local Icon = data.Data and data.Data.Icon
    local SellPrice = data.SellPrice
	local d = {
		name = data.Data.Name,
		tier = Tier,
		icon = Icon,
		sellPrice = SellPrice
	}
	return d
else
    warn("Module tidak ditemukan:", fish)
end

end
local function toFlatTable(t, path, out)
    path = path or ""
    out = out or {}

    for k, v in pairs(t) do
        local newPath = path ~= "" and (path .. "." .. k) or k

        if type(v) == "table" and not v.__type then
            toFlatTable(v, newPath, out)
        else
            out[newPath] = v
        end
    end

    return out
end

-- RE/ObtainedNewFishNotification
-- RE/FishCaught
local function extractFishNotification(text)
	local isBig = false
    local isShiny = false
    -- pastikan ini notif 
    if not string.find(text, "obtained a") then
        return nil
    end
    -- ambil nama player
    local player = string.match(text, "</b>%s*([^<]+)%s+obtained a")
    if not player then return nil end
    -- ambil warna rgb
    local tierColor = string.match(text, 'color="(rgb%b())"')
    if not tierColor then return nil end
    -- ambil isi bold (mutasi + ikan + berat)
    local itemText = string.match(text, 'color="rgb%b()"%s*>(.-)</font>')
	if not itemText then return nil end
    -- ambil berat
	local weight = string.match(itemText, "%(([%d%.]+%s*[KkMm]?%s*kg)%)")
    if not weight then return nil end
    -- hapus berat dari text
   	local noWeight = string.gsub(itemText, "%s*%b()", "")
		-- default
	local mutation = nil
	local fishName = noWeight
	local m, f = string.match(noWeight, "^([A-Z]+[%sA-Z]*)%s+(.+)$")
    if m and f and string.find(f, "%l") then
		mutation = m:gsub("%s+$", "")
		fishName = f
	end
	if string.find(fishName, "%f[%a][Bb]ig%f[%A]") then
        isBig = true
        fishName = string.gsub(fishName, "%f[%a][Bb]ig%f[%A]%s*", "")
    end
	if string.find(fishName, "%f[%a][Ss]hiny%f[%A]") then
        isShiny = true
        fishName = string.gsub(fishName, "%f[%a][Ss]hiny%f[%A]%s*", "")
    end
	if tierColor ~= "rgb(24, 255, 152)" then return end
	local fishDataMod = getFishData(fishName)
	local thumbUrl = string.gsub(fishDataMod.icon, "rbxassetid://","")
	print("=================================")
	print(player)
	print(tierColor)
	print(fishName)
	print("Mutasi: ", mutation)
	print("Weight: ", weight)
	print("is big: ", isBig)
	print("is Shiny: ", isShiny)
	print("Thumb: ", fishDataMod.icon)
	print("Sell Price: ", fishDataMod.sellPrice)
	local data = {
		playerName = player,
		fishName = fishName,
		Mutation = mutation,
		fishWeight = weight,
		fishImg = thumbUrl
	}
	local body =
    "playerName=" .. tostring(player) ..
    "&fishName=" .. tostring(fishName) ..
    "&Mutation=" .. tostring(mutation) ..
    "&fishWeight=" .. tostring(weight) ..
    "&fishImg=" .. tostring(thumbUrl)
	local success, result = pcall(function()
        return requestFunc({
            Url = apiUrl, -- Safe public HTTP test endpoint
            Method = "POST",
            Body = body
        })
    end)

end

local function tryLog(evName, ...)
	
	if evName ~= TARGET_EVENT_NAME then return end
	local args = {...}
    local text = args[1]
	extractFishNotification(text)

end
local function hookEvent(event)
	event.OnClientEvent:Connect(function(...)
		tryLog(event.Name, ...)
	end)
end

local function hookFunction(func)
	func.OnClientInvoke = function(...)
		return nil
	end
end

for _, obj in ipairs(ReplicatedStorage:GetDescendants()) do
	if obj:IsA("RemoteEvent") then
		hookEvent(obj)
	elseif obj:IsA("RemoteFunction") then
		hookFunction(obj)
	end
end

ReplicatedStorage.DescendantAdded:Connect(function(obj)
	if obj:IsA("RemoteEvent") then
		hookEvent(obj)
	elseif obj:IsA("RemoteFunction") then
		hookFunction(obj)
	end
end)
